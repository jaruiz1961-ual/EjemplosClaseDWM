@using BlazorSeguridad2026.Base.Cultures
@using System.Globalization
@using BootstrapBlazor.Components
@inject NavigationManager Navigation
@inject IContextProvider ContextProvider


<Select TValue="CultureInfo"
        Items="Culturas"
        Value="_culture"
        OnSelectedItemChanged="OnCultureChanged"
        Class="w-auto">
</Select>

@code {

    private bool _suppressCultureChange;
    private List<SelectedItem> Culturas;

    private CultureInfo _culture = CultureInfo.CurrentCulture;
    protected override void OnParametersSet()
    {
        // Cada vez que se renderiza en una nueva página,
        // sincroniza el valor desde la cultura actual, pero
        // sin disparar la lógica de cambio.
        var current = CultureInfo.CurrentCulture;

        if (_culture.Name != current.Name)
        {
            _suppressCultureChange = true;
            _culture = current;
        }
    }
    protected override async Task OnInitializedAsync()
    {
        var cs = SupportedCultures.CultureCodes;
        Culturas = cs
            .Select(c => new SelectedItem(c.Item1, c.Item2))
            .ToList();
        await base.OnInitializedAsync();
    }



    private async Task OnCultureChanged(SelectedItem item)
    {

        if (_suppressCultureChange)
        {
            _suppressCultureChange = false;
            return;
        }
        var newCulture = new CultureInfo(item.Value);

        if (_culture?.Name == newCulture.Name)
            return;

        _culture = newCulture;

        var uri = new Uri(Navigation.Uri).GetComponents(UriComponents.PathAndQuery, UriFormat.Unescaped);
        var cultureEscaped = Uri.EscapeDataString(_culture.Name);
        var uriEscaped = Uri.EscapeDataString(uri);

        if (ContextProvider.IsValid())
        {
            Navigation.NavigateTo($"Culture/Set?culture={cultureEscaped}&redirectUri={uriEscaped}", forceLoad: true);
            await ContextProvider.ReadAllContext(true);
            await ContextProvider.SetCultureName(_culture.Name);
            await ContextProvider.UpdateEstadoContext();
        }
    }
}
    
    
    