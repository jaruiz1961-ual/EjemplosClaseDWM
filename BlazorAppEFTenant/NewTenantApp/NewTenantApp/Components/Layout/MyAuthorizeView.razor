@using DataBase
@using DataBase.Genericos
@using DataBase.Servicios
@using Microsoft.AspNetCore.Components.Authorization

@inject AuthenticationStateProvider AuthStateProvider
@inject IContextProvider ContextProvider

@if (_initialized && _isAuthorized)
{
    @Authorized
}
else if (_initialized && !_isAuthorized)
{
    @NotAuthorized
}
else
{
    <text>Cargando...</text>
}

@code {
    [Parameter] public RenderFragment? Authorized { get; set; }
    [Parameter] public RenderFragment? NotAuthorized { get; set; }
    [Parameter] public string? RequiredRole { get; set; }

    private bool _isAuthorized;
    private bool _initialized;

    protected override async Task OnInitializedAsync()
    {
        // Estado inicial
        await LoadAuthStateAsync();

        // Si el AuthenticationStateProvider es tu ContextProvider, te suscribes a OnContextChanged
        if (AuthStateProvider is ContextProvider cp)
        {
            cp.OnContextChanged += ContextChanged;
        }
    }

    private async Task LoadAuthStateAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            _isAuthorized = false;
            _initialized = true;
            return;
        }

        // Si no hay rol requerido, basta con estar autenticado
        if (string.IsNullOrEmpty(RequiredRole))
        {
            _isAuthorized = true;
            _initialized = true;
            return;
        }

        // Si hay rol requerido, miramos sus claims
        _isAuthorized = user.IsInRole(RequiredRole);
        _initialized = true;
    }

    private void ContextChanged()
    {
        if (!_initialized)
            return;

        InvokeAsync(async () =>
        {
            await LoadAuthStateAsync();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        if (AuthStateProvider is ContextProvider cp)
        {
            cp.OnContextChanged -= ContextChanged;
        }
    }
}
