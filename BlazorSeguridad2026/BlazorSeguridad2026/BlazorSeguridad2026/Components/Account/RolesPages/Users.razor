@page "/users"
@using BlazorSeguridad2026.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@* @attribute [Authorize(Roles = "Admin")] *@
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject IUserService UserService
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Nav 

<h3>Administración de usuarios</h3>

@if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
@if (!string.IsNullOrEmpty(success))
{
    <div class="alert alert-success">@success</div>
}

<h4>Crear usuario</h4>
<div>
    <label>Email</label>
    <InputText @bind-Value="newEmail" />
</div>
<div>
    <label>Password</label>
    <InputText @bind-Value="newPassword" type="password" />
</div>
<button @onclick="CreateUser">Crear</button>

<hr />

<h4>Lista de usuarios</h4>

@if (users is null)
{
    <p>Cargando...</p>
}
else if (users.Count == 0)
{
    <p>No hay usuarios.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Email</th>
                <th>Id</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in users)
            {
                <tr class="@(selectedUserId == u.Id ? "table-primary" : "")">
                    <td>
                        @if (editingUserId == u.Id)
                        {
                            <InputText @bind-Value="editEmail" />
                        }
                        else
                        {
                            @u.Email
                        }
                    </td>
                    <td>@u.Id</td>
                    <td>
                        @if (editingUserId == u.Id)
                        {
                            <button @onclick="SaveEdit">Guardar</button>
                            <button @onclick="CancelEdit">Cancelar</button>
                        }
                        else
                        {
                            <button @onclick="@(() => Nav.NavigateTo($"/users/{u.Id}/roles"))">Roles</button>


                            <button @onclick="() => StartEdit(u)">Editar</button>
                            <button @onclick="() => DeleteUser(u.Id)">Borrar</button>
                            <button @onclick="() => SelectUser(u.Id)">Roles</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (selectedUserId is not null)
{
    <hr />
    <h4>Roles del usuario seleccionado</h4>

    @if (allRoles is null)
    {
        <p>Cargando roles...</p>
    }
    else
    {
        <p><strong>Usuario Id:</strong> @selectedUserId</p>

        @foreach (var role in allRoles)
        {
            <div>
                <input type="checkbox"
                       checked="@selectedUserRoles.Contains(role.Name!)"
                       @onchange="e => ToggleRole(role.Name!, e.Value)" />
                <span>@role.Name</span>
            </div>
        }

        <button @onclick="SaveRoles">Guardar roles</button>
    }
}

@code {
    private List<ApplicationUser>? users;
    private string newEmail = string.Empty;
    private string newPassword = string.Empty;
    private string? error;
    private string? success;

    // edición de email
    private string? editingUserId;
    private string? editEmail;

    // roles del usuario seleccionado
    private string? selectedUserId;
    private List<IdentityRole>? allRoles;
    private HashSet<string> selectedUserRoles = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private async Task LoadUsersAsync()
    {
        users = await UserService.GetAllAsync();
    }

    private async Task CreateUser()
    {
        error = success = null;

        if (string.IsNullOrWhiteSpace(newEmail) || string.IsNullOrWhiteSpace(newPassword))
        {
            error = "Email y password son obligatorios.";
            return;
        }

        var result = await UserService.CreateAsync(newEmail, newPassword);

        if (result.Succeeded)
        {
            success = "Usuario creado.";
            newEmail = string.Empty;
            newPassword = string.Empty;
            await LoadUsersAsync();
        }
        else
        {
            error = string.Join(" ", result.Errors.Select(e => e.Description));
        }
    }

    private void StartEdit(IdentityUser user)
    {
        editingUserId = user.Id;
        editEmail = user.Email;
        error = success = null;
    }

    private async Task SaveEdit()
    {
        if (editingUserId is null || string.IsNullOrWhiteSpace(editEmail))
        {
            error = "Datos de edición no válidos.";
            return;
        }

        var result = await UserService.UpdateEmailAsync(editingUserId, editEmail);

        if (result.Succeeded)
        {
            success = "Usuario actualizado.";
            editingUserId = null;
            editEmail = null;
            await LoadUsersAsync();
        }
        else
        {
            error = string.Join(" ", result.Errors.Select(e => e.Description));
        }
    }

    private void CancelEdit()
    {
        editingUserId = null;
        editEmail = null;
    }

    private async Task DeleteUser(string id)
    {
        error = success = null;

        var result = await UserService.DeleteAsync(id);

        if (result.Succeeded)
        {
            success = "Usuario borrado.";
            if (selectedUserId == id)
            {
                selectedUserId = null;
                allRoles = null;
                selectedUserRoles.Clear();
            }
            await LoadUsersAsync();
        }
        else
        {
            error = string.Join(" ", result.Errors.Select(e => e.Description));
        }
    }

    private async Task SelectUser(string id)
    {
        selectedUserId = id;
        error = success = null;

        // cargar todos los roles una vez
        allRoles ??= RoleManager.Roles.ToList();

        // cargar roles actuales del usuario
        var roles = await UserService.GetUserRolesAsync(id);
        selectedUserRoles = new HashSet<string>(roles, StringComparer.OrdinalIgnoreCase);
    }

    private void ToggleRole(string roleName, object? isChecked)
    {
        var check = isChecked is bool b && b;
        if (check)
            selectedUserRoles.Add(roleName);
        else
            selectedUserRoles.Remove(roleName);
    }

    private async Task SaveRoles()
    {
        if (selectedUserId is null)
        {
            error = "Ningún usuario seleccionado.";
            return;
        }

        var result = await UserService.SetUserRolesAsync(selectedUserId, selectedUserRoles);

        if (result.Succeeded)
        {
            success = "Roles actualizados.";
        }
        else
        {
            error = string.Join(" ", result.Errors.Select(e => e.Description));
        }
    }
}
