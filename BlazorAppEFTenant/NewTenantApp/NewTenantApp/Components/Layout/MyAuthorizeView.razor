@using DataBase
@using DataBase.Genericos
@using DataBase.Servicios
@inject IContextProvider ContextProvider

@inject IConfiguration Configuration


@if (_initialized && _isAuthorized)
{
    @Authorized
}
else if (_initialized && !_isAuthorized)
{
    @NotAuthorized
}
else
{
    <text>Cargando...</text>
}

@code {
    [Parameter] public RenderFragment? Authorized { get; set; }
    [Parameter] public RenderFragment? NotAuthorized { get; set; }
    [Parameter] public string? RequiredRole { get; set; }

    private bool _isAuthorized;
    private bool _initialized;

    protected override void OnInitialized()
    {
        ContextProvider.OnContextChanged += ContextChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Aquí ya hay JS disponible para Blazored.LocalStorage
            await ContextProvider.ReadContext();
            EvaluateAuthorization();
            _initialized = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ContextChanged()
    {
        if (_initialized)
        {
            EvaluateAuthorization();
            InvokeAsync(StateHasChanged);
        }
    }

    private void EvaluateAuthorization()
    {
        var token = ContextProvider.Token;

        if (string.IsNullOrEmpty(token) || !TokenService.ValidateToken(token,Configuration))
        {
            _isAuthorized = false;
            return;
        }

        var sc = ServicioSeguridad.GetDataFromToken(token);

        _isAuthorized = string.IsNullOrEmpty(RequiredRole)
            || string.Equals(sc.Roles, RequiredRole, StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        ContextProvider.OnContextChanged -= ContextChanged;
    }
}
