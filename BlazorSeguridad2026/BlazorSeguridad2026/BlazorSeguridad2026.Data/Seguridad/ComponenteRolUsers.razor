@* @page "/seguridad/roles/{RoleId}/users" *@
@namespace BlazorSeguridad2026.Data.Seguridad
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using BlazorSeguridad2026.Data
@using Shares.Seguridad
@using BlazorSeguridad2026.Components.Seguridad
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject IUserService UserService
@inject RoleManager<ApplicationRole> RoleManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav

<h3>Usuarios en el rol</h3>

@if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
@if (!string.IsNullOrEmpty(success))
{
    <div class="alert alert-success">@success</div>
}

@if (isLoading)
{
    <p>Cargando...</p>
}
else if (role is null)
{
    <div class="alert alert-warning">Rol no encontrado.</div>
    <button class="btn btn-secondary" @onclick="BackToRoles">
        Volver a roles
    </button>
}
else
{
    <div class="card mb-3">
        <div class="card-body">
            <p class="mb-1"><strong>Rol:</strong> @role.Name</p>
            <p class="mb-0 text-muted"><strong>Id:</strong> @role.Id</p>
            <p class="mb-0 text-muted"><strong>TenantId:</strong> @role.TenantId</p>
            <p class="mb-0 text-muted"><strong>DbKey:</strong> @role.DbKey</p>
        </div>
    </div>

    <div class="row">
        <!-- Usuarios en el rol -->
        <div class="col-md-6">
            <h4>Usuarios en este rol</h4>

            @if (usersInRole.Count == 0)
            {
                <p>No hay usuarios en este rol.</p>
            }
            else
            {
                <table class="table table-sm table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Email</th>
                            <th style="width: 120px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var u in usersInRole)
                        {
                            <tr>
                                <td>@u.Email</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger"
                                            @onclick="() => RemoveFromRole(u.Id)">
                                        Quitar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        <!-- Añadir usuarios al rol -->
        <div class="col-md-6">
            <h4>Añadir usuario a este rol</h4>

            @if (usersNotInRole.Count == 0)
            {
                <p>No hay más usuarios disponibles para asignar.</p>
            }
            else
            {
                <div class="mb-2">
                    <select class="form-select" @bind="selectedUserToAddId">
                        <option value="">-- Selecciona un usuario --</option>
                        @foreach (var u in usersNotInRole)
                        {
                            <option value="@u.Id">@u.Email</option>
                        }
                    </select>
                </div>
                <button class="btn btn-primary"
                        @onclick="AddToRole"
                        disabled="@string.IsNullOrEmpty(selectedUserToAddId)">
                    Añadir al rol
                </button>
            }
        </div>
    </div>

    <hr />
    <button class="btn btn-secondary" @onclick="BackToRoles">
        Volver a roles
    </button>
}

@code {
    [Parameter] public string RoleId { get; set; } = string.Empty;
    [Parameter] public int? TenantId { get; set; } = null;

    private ApplicationRole? role;
    private List<ApplicationUser> usersInRole = new();
    private List<ApplicationUser> usersNotInRole = new();

    private string? selectedUserToAddId;

    private bool isLoading = true;
    private string? error;
    private string? success;

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        error = success = null;

        role = await RoleManager.FindByIdAsync(RoleId);
        if (role is null)
        {
            isLoading = false;
            return;
        }
        await LoadUsersForRole();

        isLoading = false;
    }



    private async Task LoadUsersForRole()
    {
        isLoading = true;
        usersInRole.Clear();
        usersNotInRole.Clear();

        // Todos los usuarios
        var allUsers = await UserService.GetAllAsync();

        // Usuarios en el rol (puedes usar GetUsersInRoleAsync o IsInRoleAsync por usuario)
        // Aquí uso GetUsersInRoleAsync para eficiencia
        var inRole = await UserManager.GetUsersInRoleAsync(role!.Name!);

        var inRoleIds = new HashSet<string>(inRole.Select(u => u.Id.ToString()));

        usersInRole = allUsers.Where(u => u.TenantId==role.TenantId && inRoleIds.Contains(u.Id.ToString())).ToList();
        usersNotInRole = allUsers.Where(u => u.TenantId == role.TenantId && !inRoleIds.Contains(u.Id.ToString())).ToList();
        isLoading = false;
    }

    private async Task AddToRole()
    {
        if (role is null || string.IsNullOrEmpty(selectedUserToAddId))
            return;

        error = success = null;

        var user = await UserManager.FindByIdAsync(selectedUserToAddId);
        if (user is null)
        {
            error = "Usuario no encontrado.";
            return;
        }

        var result = await UserManager.AddToRoleAsync(user, role.Name!);

        if (result.Succeeded)
        {
            success = "Usuario añadido al rol.";
            selectedUserToAddId = null;
            await LoadUsersForRole();
        }
        else
        {
            error = string.Join(" ", result.Errors.Select(e => e.Description));
        }
    }

    private async Task RemoveFromRole(int userId)
    {
        if (role is null)
            return;

        error = success = null;

        var user = await UserManager.FindByIdAsync(userId.ToString());
        if (user is null)
        {
            error = "Usuario no encontrado.";
            return;
        }

        var result = await UserManager.RemoveFromRoleAsync(user, role.Name!);

        if (result.Succeeded)
        {
            success = "Usuario quitado del rol.";
            await LoadUsersForRole();
        }
        else
        {
            error = string.Join(" ", result.Errors.Select(e => e.Description));
        }
    }

    private void BackToRoles() => Nav.NavigateTo("/roles");
}
