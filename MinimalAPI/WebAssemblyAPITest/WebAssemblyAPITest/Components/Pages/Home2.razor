@page "/Home2"
@rendermode InteractiveServer
@using WebAssemblyAPITest.Client.Services
@inject HttpClient Http
@inject CookieService CookieService

<h3>Login para obtener token JWT</h3>

<div>
    <input @bind="username" placeholder="Usuario" />
</div>

<button @onclick="LoginAsync">Acceder</button>

@if (!string.IsNullOrEmpty(token))
{
    <p>Token recibido: @token</p>
    <button @onclick="CallProtectedApi">Llamar API protegida</button>
    <p>@protectedApiResponse</p>
}

@if (!string.IsNullOrEmpty(token))
{
    <p>Token recibido: @tokenCookie</p>
    <button @onclick="CallProtectedApiCookie">Llamar API protegida Cookie</button>
    <p>@protectedApiResponseCookie</p>
}

@code {
    string username = "";
    string password = "";
    string token = "";
    string tokenCookie = "";

    string protectedApiResponse = "";
    string protectedApiResponseCookie = "";

    async Task LoginAsync()
    {

        var response = await Http.PostAsJsonAsync("https://localhost:7242/login", username);

        if (response.IsSuccessStatusCode)
        {
            var json = await response.Content.ReadFromJsonAsync<LoginResult>();
            token = json.Token;
            var tokenCookie = await CookieService.GetTokenAsync();
            await CookieService.SetTokenAsync(tokenCookie, 1);
        }
        else
        {
            token = "Acceso denegado.";
        }
    }

    async Task CallProtectedApi()
    {
        if (!string.IsNullOrEmpty(token))
        {
            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.GetAsync("https://localhost:7242/secured-route");

            if (response.IsSuccessStatusCode)
            {
                protectedApiResponse = await response.Content.ReadAsStringAsync();
            }
            else
            {
                protectedApiResponse = "No autorizado";
            }
        }
    }

    async Task CallProtectedApiCookie()
    {
        if (!string.IsNullOrEmpty(token))
        {
            var tokenCookie = await CookieService.GetTokenAsync();
             Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", tokenCookie);

            var response = await Http.GetAsync("https://localhost:7242/secured-route");

            if (response.IsSuccessStatusCode)
            {
                protectedApiResponse = await response.Content.ReadAsStringAsync();
            }
            else
            {
                protectedApiResponse = "No autorizado";
            }
        }
    }

    class LoginResult
    {
        public string Token { get; set; }
    }
}

