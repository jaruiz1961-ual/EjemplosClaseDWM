@page "/Login"
@* SIN @rendermode aquí; que el Router decida el modo *@

@using Blazored.LocalStorage
@using DataBase
@using DataBase.Genericos
@using DataBase.Modelo
@using DataBase.Servicios
@inject IUnitOfWorkFactory UowFactory
@inject ITokenService TokenService
@inject IContextProvider ContextProvider
@inject NavigationManager Nav
@inject ILocalStorageService LocalStorage
@* @inject IServiceProvider Services   para resolver ServicioSeguridad si quieres DI *@ 

<h3>Login para obtener token JWT desde el cliente</h3>

<div>
    <input @bind="username" placeholder="Usuario" />
    <input @bind="password" placeholder="Password" type="password" />
</div>

<button @onclick="LoginAsync">Acceder</button>

<p>@mensaje</p>

@if (seguridad is not null && !string.IsNullOrEmpty(seguridad.UserName))
{
    <p>Token: @ContextProvider._AppState.Token</p>
    <p>Nombre: @seguridad.UserName</p>
    <p>Password: @seguridad.Password</p>
    <p>TenantId: @seguridad.TenantId</p>
    <p>Email: @seguridad.Email</p>
    <p>Roles: @seguridad.Roles</p>
}
else
{
    <p>¡Haz login para empezar!</p>
}

@code {
    [CascadingParameter]
    public IAppState AppState { get; set; } = default!;

    private string username = string.Empty;
    private string password = string.Empty;
    private string mensaje  = string.Empty;

    private Seguridad seguridad = new();

    private async Task LoginAsync()
    {
        mensaje = string.Empty;

        // Contexto de conexión que quieres para este login
        ContextProvider._AppState.ConnectionMode = "Ef";

        // Mejor: resolver ServicioSeguridad vía DI; aquí lo instancio a mano por simplicidad
        var scUsuario = new ServicioSeguridad(ContextProvider, UowFactory, TokenService);

        var token = await scUsuario.LoginAndGetToken(username, password);

        if (!string.IsNullOrEmpty(token))
        {
            seguridad = scUsuario.GetDataFromToken() ?? new Seguridad();

            // Actualizar TODO el contexto a través de SetContext para que Blazor se entere
            await ContextProvider.SetContext(
                tenantId:       seguridad.TenantId,
                dbKey:   ContextProvider._AppState.DbKey,
                apiName:        ContextProvider._AppState.ApiName,
                dirBase:        ContextProvider._AppState.DirBase,
                connectionMode:  ContextProvider._AppState.ConnectionMode,
                token:          token
            );

            // Reflejar también en AppState de cascada si lo usas en otras partes
            AppState.Token          = token;
            AppState.IsAutenticated = true;

            mensaje = $"Bienvenido: {seguridad.UserName} ({seguridad.Roles})";

            // Redirigir donde quieras, por ejemplo a Home
            // Nav.NavigateTo("/Home");
        }
        else
        {
            seguridad = new Seguridad();
            AppState.IsAutenticated = false;
            mensaje = "Error en Login";
        }

        StateHasChanged();
    }
}
