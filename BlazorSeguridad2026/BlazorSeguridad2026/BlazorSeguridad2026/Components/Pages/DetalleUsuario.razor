@page "/DetalleUsuario"
@page "/DetalleUsuario/{Id:int}"    //esta página se puede acceder tambien en modo de edición
@rendermode @(new InteractiveServerRenderMode(prerender: true))


@using BlazorSeguridad2026.Base.Genericos
@using BlazorSeguridad2026.Base.Seguridad
@using BlazorSeguridad2026.Data.Modelo
@using BlazorSeguridad2026.Data.Servicios


@using BootstrapBlazor.Components


@inject IUnitOfWorkFactory UnitOfWorkFactory 
@inject IContextProvider ContextProvider 

@inject NavigationManager nav
@implements IDisposable

@using BibliotecaContextosDb.Resources


<p>Prueba recurso: @UsuarioResources.User_Codigo_Label</p>


<p>TenantId <strong>@ContextProvider.AppState.TenantId</strong>:</p>
<p>ContextKeDb <strong>@ContextProvider.AppState.DbKey</strong>:</p>
<p>ApiName <strong>@ContextProvider.AppState.ApiName</strong>:</p>

<CultureSelector></CultureSelector>

@if (newUserModel is not null){
    <ValidateForm Model="@newUserModel"
                  OnValidSubmit="@HandleValidSubmit"
                  OnInvalidSubmit="@HandleInvalidSubmit"
                  FormName="DetalleUsuarioForm">

        <EditorForm TModel="UserModel"
                    Model="@newUserModel"
                    ItemsPerRow="1"
                    RowType="RowType.Inline"
                    LabelAlign="Alignment.Right">

            <FieldItems>

                <!-- Código -->
@*                 <EditorItem @bind-Field="@newUserModel.Codigo"
                            Text="@CodigoLabel" /> *@



                <EditorItem @bind-Field="@newUserModel.Codigo"
                            Text="@DisplayNameExtensions.GetDisplayName(m => m.Codigo)" />
                <!-- UserName -->
                <EditorItem @bind-Field="@newUserModel.UserName" />



                <!-- NivelAcceso / Contexto -->
                <EditorItem @bind-Field="@newUserModel.Contexto" />

                <!-- Password -->
                <EditorItem @bind-Field="@newUserModel.Password"
                             />

                <!-- Email -->
                <EditorItem @bind-Field="@newUserModel.Email"
                             />

                <!-- Tenant -->
                <EditorItem @bind-Field="@newUserModel.TenantId" />

            </FieldItems>
        </EditorForm>

        @if (displayValidationErrorMessages)
        {
            <div class="mt-2">
                <ValidationSummary />
            </div>
        }

        <div class="form-footer mt-3">
            <Button ButtonType="@ButtonType.Submit"
                    Color="Color.Primary"
                    Text="Save" />
            <Button ButtonType="@ButtonType.Button"
                    Color="Color.Secondary"
                    Text="Cancel"
                    OnClick="@Cancel"
                    CssClass="ms-2" />
        </div>
    </ValidateForm>

}



@code {

    [Parameter]
    public int Id { get; set; }

    int currentCount = 0;
    private bool _initialized;
    private bool _isInitializing;
    private string estadoCliente = "";
    private string estadoServidor;
    bool _isValidContext;
    public UserModel? newUserModel { get; set; } = new UserModel();

    public Usuario? newUser { get; set; } = new Usuario();

    bool displayValidationErrorMessages;
    bool displayUserAddedToDB;
    IContextProvider localContext;

    private void OnContextChangedProxy() => _ = HandleContextChangedAsync();



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _isInitializing || _initialized)
            return;

        _isInitializing = true;

        // 1. Suscribirse a eventos del contexto
        ContextProvider.OnContextChanged += OnContextChangedProxy;

        // 2. Inicializar desde localStorage (JS interop seguro aquí)
        localContext = await ContextProvider.CreateReadAll(); 

        // 3. Leer estado actual
        estadoCliente = localContext.GetValor(ClavesEstado.PaginaCliente) ?? "Ninguno";
        estadoServidor = localContext.GetValor(ClavesEstado.PaginaServidor) ?? "Ninguno";


        // 4. Persistir de nuevo en el contexto

        await ContextProvider.UpdateEstadoContext();

        _initialized = true;
        _isInitializing = false;

        await CargarAsync();
    }

    private async Task HandleContextChangedAsync()
    {
        // 6. Reaccionar a cambios posteriores de contexto
        await CargarAsync();
        InvokeAsync(StateHasChanged);
    }


    private async Task HandleValidSubmit(EditContext context)
    {
        displayValidationErrorMessages = false;
        displayUserAddedToDB = true;
        ServicioUsuarios? servicioUsuario = null;
        if (servicioUsuario is null)
            servicioUsuario = new ServicioUsuarios(localContext, UnitOfWorkFactory);
        newUser.UpdateFromModel(newUserModel);
        if (Id != 0)
            servicioUsuario.ActualizarAsync(newUser,true);
        else
            servicioUsuario.AñadirAsync(newUser,true);

        nav.NavigateTo("javascript:history.back()");

        //nav.NavigateTo("/ListaUsuarios");
    }


    private async Task HandleInvalidSubmit(EditContext context)
    {
        displayValidationErrorMessages = true;
        displayUserAddedToDB = false;
        //  nav.NavigateTo("/ListaUsuarios");
    }




    private async Task CargarAsync()
    {

        try
        {
            if (Id != 0)
            {
                ServicioUsuarios? servicioUsuario = null;

                if (servicioUsuario is null)
                    servicioUsuario = new ServicioUsuarios(localContext, UnitOfWorkFactory);

                newUser = await servicioUsuario.ObtenerPorIdAsync(Id,true);
                newUserModel = newUser.SaveToModel();
            }
            else 
            {

            }

        }
        catch (Exception ex)
        {

            throw;
        }
    }

    protected void Cancel()
    {
        nav.NavigateTo("javascript:history.back()");
        //nav.NavigateTo("/ListaUsuarios");
    }

    public void Dispose()
    {
        // 7. Desuscribirse para evitar fugas de memoria
        ContextProvider.OnContextChanged -= OnContextChangedProxy;
    }


}

