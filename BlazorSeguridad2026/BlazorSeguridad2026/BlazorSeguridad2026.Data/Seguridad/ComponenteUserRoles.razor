@* @page "/seguridad/users/{UserId}/roles" *@
@rendermode InteractiveAuto
@namespace BlazorSeguridad2026.Data.Seguridad

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using BlazorSeguridad2026.Components.Seguridad

@using BlazorSeguridad2026.Data
@using Shares.Seguridad

@* @attribute [Authorize(Roles = "Admin")] *@

@inject IUserService UserService
@inject RoleManager<ApplicationRole> RoleManager
@inject NavigationManager Nav


<h3>Asignar roles al usuario</h3>

@if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
@if (!string.IsNullOrEmpty(success))
{
    <div class="alert alert-success">@success</div>
}

@if (isLoading)
{
    <p>Cargando...</p>
}
else if (user is null)
{
    <div class="alert alert-warning">Usuario no encontrado.</div>
    <button class="btn btn-secondary" @onclick="BackToUsers">
        Volver a usuarios
    </button>
}
else
{
    <div class="card mb-3">
        <div class="card-body">
            <p class="mb-1">
                <strong>Usuario:</strong> @user.Email
            </p>
            <p class="mb-0 text-muted">
                <strong>Id:</strong> @user.Id
            </p>
            <p class="mb-0 text-muted">
                <strong>TenantId:</strong> @user.TenantId
            </p>
            <p class="mb-0 text-muted">
                <strong>DbKey:</strong> @user.DbKey
            </p>
        </div>
    </div>

    <h4>Roles</h4>

    @if (allRoles.Count == 0)
    {
        <p>No hay roles definidos.</p>
    }
    else
    {
        <div class="mb-3">
            @foreach (var role in allRoles)
            {
                <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           checked="@selectedRoles.Contains(role.Name!)"
                           @onchange="e => ToggleRole(role.Name!, e.Value)" />
                    <label class="form-check-label">
                        @role.Name
                    </label>
                </div>
            }
        </div>

        <button class="btn btn-primary me-2" @onclick="SaveRoles">
            Guardar roles
        </button>
        <button class="btn btn-secondary" @onclick="BackToUsers">
            Volver a usuarios
        </button>
    }
}

@code {
    [Parameter]
    public int userId { get; set; } 
    [Parameter]
    [SupplyParameterFromQuery]
    public string? From { get; set; }

    private ApplicationUser? user;
    private List<ApplicationRole> allRoles = new();
    private HashSet<string> selectedRoles = new(StringComparer.OrdinalIgnoreCase);

    private bool isLoading = true;
    private string? error;
    private string? success;
  

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        error = success = null;
    
        user = await UserService.GetByIdAsync(userId);
        if (user is null)
        {
            isLoading = false;
            return;
        }
        await LoadRolesAsync();
        isLoading = false;

    }

    private async Task LoadRolesAsync()
    {
        isLoading = true;
        // todos los roles existentes
        allRoles = RoleManager.Roles
            .Where(r => r.TenantId == user.TenantId)
        .OrderBy(r => r.Name)
            .ToList();
        // roles actuales del usuario Filtrados 

        var userRoles = await UserService.GetUserRolesAsync(int.Parse(userId.ToString()));
        selectedRoles = new HashSet<string>(userRoles, StringComparer.OrdinalIgnoreCase);

        isLoading = false;
   

    }

    private void ToggleRole(string roleName, object? isChecked)
    {
        var check = isChecked is bool b && b;
        if (check)
            selectedRoles.Add(roleName);
        else
            selectedRoles.Remove(roleName);
    }

    private async Task SaveRoles()
    {
        if (user is null)
        {
            error = "Usuario no encontrado.";
            return;
        }

        var result = await UserService.SetUserRolesAsync(user.Id, selectedRoles);

        if (result.Succeeded)
        {
            success = "Roles actualizados.";
        }
        else
        {
            error = string.Join(" ", result.Errors.Select(e => e.Description));
        }
    }

    private void BackToUsers()
    {
        if (!string.IsNullOrEmpty(From))
            Nav.NavigateTo(From);
        else
            Nav.NavigateTo("/seguridad/users"); // fallback

    }
}